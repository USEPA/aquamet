---
title: "Calculating Relative Bed Stability"
author: "Karen Blocksom "
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calculating Bed Stability}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# 1 Preliminaries

Bed stability is important to measuring physical habitat condition in streams for the National Rivers and Streams Assessment. The function `nrsaBedStability` uses metrics calculated from other functions in this package, some of which have different names for boatable and wadeable versions, to calculate a number of metrics related to bed stability. The purpose of this vignette is to provide an example of the calculation of bed stability metrics using the outputs of other physical habitat functions. 

********
# 2 Calculating Bed Stability

First calculate all of the input metrics required as inputs. The following functions calculate the necessary input metrics: 
`nrsaChannelMorphology()`, `nrsaFishCover()`, `nrsaLargeWoody()`, `nrsaResidualPools()`, `nrsaSlopeBearing()`, `nrsaSubstrateCharacterization()`. In turn, some of those functions use data from other functions. The function `nrsaGeneral()` feeds reach length into `nrsaLargeWoody()`.

## 2.1 Channel morphology metrics
For this function, all data inputs are required to use the function.
```{r chanmorph}
library(aquamet)
library(stringr)

head(bankgeomEx)
head(thalwegEx)

bBH <- subset(bankgeomEx,PARAMETER=='BANKHT' & SAMPLE_TYPE=='PHAB_CHANBFRONT')
bBW <- subset(bankgeomEx,PARAMETER=='BANKWID' & SAMPLE_TYPE=='PHAB_CHANBFRONT')
bD <- subset(thalwegEx,(PARAMETER=='DEP_SONR'|PARAMETER=='DEP_POLE') & SAMPLE_TYPE=='PHAB_THAL')
bWW <- subset(bankgeomEx,PARAMETER=='WETWID' & SAMPLE_TYPE=='PHAB_CHANBFRONT')
bInc <- subset(bankgeomEx,PARAMETER=='INCISED' & SAMPLE_TYPE=='PHAB_CHANBFRONT')
wBH <- subset(bankgeomEx,PARAMETER=='BANKHGT' & SAMPLE_TYPE=='PHAB_CHANW')
wBW <- subset(bankgeomEx,PARAMETER=='BANKWID' & SAMPLE_TYPE=='PHAB_CHANW')
wD <- subset(thalwegEx,PARAMETER=='DEPTH' & SAMPLE_TYPE=='PHAB_THALW')
wWW <- subset(thalwegEx,PARAMETER=='WETWIDTH')
wInc <- subset(bankgeomEx,PARAMETER=='INCISHGT' & SAMPLE_TYPE=='PHAB_CHANW')

chanmorphOut <- nrsaChannelMorphology(bBankHeight=bBH, bBankWidth=bBW,
bDepth=bD, bIncisedHeight=bInc, bWettedWidth=bWW, wBankHeight=wBH,
wBankWidth=wBW, wDepth=wD, wIncisedHeight=wInc, wWettedWidth=wWW)

head(chanmorphOut)

```

## 2.2 Fish cover metrics

```{r fishcvr}
head(fishcoverEx)
 
fishCvrOut <- nrsaFishCover(algae=subset(fishcoverEx,PARAMETER=='ALGAE'),
  boulder=subset(fishcoverEx,PARAMETER=='BOULDR'),
  brush=subset(fishcoverEx,PARAMETER=='BRUSH'),
  liveTree=subset(fishcoverEx,PARAMETER=='LVTREE'),
  macrophytes=subset(fishcoverEx,PARAMETER=='MACPHY'),
  overhang=subset(fishcoverEx,PARAMETER=='OVRHNG'),
  structures=subset(fishcoverEx,PARAMETER=='STRUCT'),
  undercut=subset(fishcoverEx,PARAMETER=='UNDCUT'),
  woodyDebris=subset(fishcoverEx,PARAMETER=='WOODY'))

head(fishCvrOut)

```
## 2.3 Large woody debris metrics
```{r lwd}

boatCnt <- subset(woodEx,SITE %in% subset(visitsEx,VALXSITE=='BOATABLE',select='UID')$UID)
wadeCnt <- subset(woodEx,SITE %in% subset(visitsEx,VALXSITE=='WADEABLE',select='UID')$UID) 
meanBankfull <- subset(chanmorphOut,METRIC=='xbkf_w')

# Run nrsaGeneral() to obtain reach length metric
wTr <- subset(thalwegEx,PARAMETER=='INCREMNT',select=c('SITE','TRANSECT','VALUE'))
bTr <- subset(changeomEx,PARAMETER=='ACTRANSP',select=c('SITE','TRANSECT','VALUE'))
tranSpace <- rbind(wTr,bTr) %>% plyr::mutate(VALUE=as.numeric(VALUE))

reachLen <- nrsaGeneral(sampledTransects=unique(thalwegEx[,c('SITE','TRANSECT')]),
                        sideChannels=subset(thalwegEx,PARAMETER %in% c('SIDCHN','OFF_CHAN')),
                        transectSpacing=tranSpace, 
                        sideChannelTransects=c('XA','XB','XC','XD','XE','XF','XG','XH','XI','XJ','XK'))
  
# Now feed these data frames into the function nrsaLargeWoody()
lwdOut <- nrsaLargeWoody(bCounts=boatCnt,wCounts=wadeCnt,reachlength=subset(reachLen,METRIC=='reachlen'),
                         meanBankfullWidth=meanBankfull)

```




